"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var dependencyGraph=require("dependency-graph"),json=require("@stoplight/json"),path=require("@stoplight/path"),produce=require("immer"),produce__default=_interopDefault(produce),lodash=require("lodash"),URI=require("urijs");class Cache{constructor(e={}){this._stats={hits:0,misses:0},this._data={},this._stdTTL=e.stdTTL}get stats(){return this._stats}get(e){const t=this._data[e];if(t&&(!this._stdTTL||(new Date).getTime()-t.ts<this._stdTTL))return this._stats.hits+=1,t.val;this._stats.misses+=1}set(e,t){this._data[e]={ts:(new Date).getTime(),val:t}}has(e){return e in this._data}}function __awaiter(e,t,r,s){return new(r||(r=Promise))(function(i,o){function n(e){try{h(s.next(e))}catch(e){o(e)}}function a(e){try{h(s.throw(e))}catch(e){o(e)}}function h(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(n,a)}h((s=s.apply(e,t||[])).next())})}const replace=(e,t,r)=>{const s=e.toString();let i="",o=s,n=0,a=o.indexOf(t);for(;a>-1;)i+=s.substring(n,n+a)+r,o=o.substring(a+t.length,o.length),n+=a+t.length,a=o.indexOf(t);return o.length>0&&(i+=s.substring(s.length-o.length,s.length)),i},encodeFragmentSegment=e=>replace(replace(e,"~","~0"),"/","~1"),addToJSONPointer=(e,t)=>`${e}/${encodeFragmentSegment(t)}`,uriToJSONPointer=e=>e&&e.fragment()?`#${e.fragment()}`:"",uriIsJSONPointer=e=>"#/"===e.toString().slice(0,2);class ResolveCrawler{constructor(e,t){this.resolvers=[],this.pointerGraph=new dependencyGraph.DepGraph({circular:!0}),this.pointerStemGraph=new dependencyGraph.DepGraph({circular:!0}),this.computeGraph=((e,t=[],r="#",s=[])=>{r||(r="#");let i=this._runner.computeRef({val:e,jsonPointer:r,pointerStack:s});if(i)this._resolveRef({ref:i,val:e,parentPath:t,pointerStack:s,parentPointer:r,cacheKey:r,resolvingPointer:this.jsonPointer});else if("object"==typeof e)for(const o in e){if(!e.hasOwnProperty(o))continue;const n=e[o],a=addToJSONPointer(r,o);i=this._runner.computeRef({key:o,val:n,jsonPointer:a,pointerStack:s}),t.push(o),i?this._resolveRef({ref:i,val:n,parentPath:t,parentPointer:a,pointerStack:s,cacheKey:uriToJSONPointer(i),resolvingPointer:this.jsonPointer}):"object"==typeof n&&this.computeGraph(n,t,a,s),t.pop()}}),this._resolveRef=(e=>{const{pointerStack:t,parentPath:r,parentPointer:s,ref:i}=e;if(uriIsJSONPointer(i)){if(this._runner.dereferenceInline){const e=uriToJSONPointer(i),o=json.pointerToPath(e);let n=!0;for(const e in o)if(r[e]!==o[e]){n=!1;break}if(n)return;this.pointerStemGraph.hasNode(e)||this.pointerStemGraph.addNode(e);let a="#",h="";for(let t=0;t<r.length;t++){const i=r[t];if(i===o[t])a+=`/${i}`;else{const t=`${a}${h+=`/${i}`}`;t!==s&&t!==e&&(this.pointerStemGraph.hasNode(t)||this.pointerStemGraph.addNode(t),this.pointerStemGraph.addDependency(t,e))}}this.pointerGraph.hasNode(s)||this.pointerGraph.addNode(s),this.pointerGraph.hasNode(e)||this.pointerGraph.addNode(e);const c=`${this._runner.baseUri.toString()}${e}`;this._runner.graph.hasNode(c)||this._runner.graph.addNode(c,{refMap:{}}),this._runner.root!==c&&this._runner.graph.addDependency(this._runner.root,c),this.pointerGraph.addDependency(s,e),this.jsonPointer&&(t.push(e),this.computeGraph(lodash.get(this._runner.source,o),o,e,t),t.pop())}}else{const t=i.toString();this._runner.graph.hasNode(t)||this._runner.graph.addNode(t,{refMap:{}}),this._runner.root!==t&&this._runner.graph.addDependency(this._runner.root,t),this._runner.dereferenceRemote&&!this._runner.atMaxUriDepth()&&this.resolvers.push(this._runner.lookupAndResolveUri(e))}}),this.jsonPointer=t,this._runner=e}}const memoize=require("fast-memoize");let resolveRunnerCount=0;const defaultGetRef=(e,t)=>{if(t&&"object"==typeof t&&"string"==typeof t.$ref)return t.$ref};class ResolveRunner{constructor(e,t=new dependencyGraph.DepGraph({circular:!0}),r={}){this.ctx={},this.computeRef=(e=>{const t=this.getRef(e.key,e.val);if(!t)return;let r=new URI(t);if("#"!==r.toString().charAt(0)){if(this.isFile(r)){let e=r.toString();r.is("absolute")||(e=this.baseUri.toString()?path.join(path.dirname(this.baseUri.toString()),path.stripRoot(e)):""),e&&(r=new URI(path.toFSPath(e)).fragment(r.fragment()))}else(r.scheme().includes("http")||""===r.scheme()&&this.baseUri.scheme().includes("http"))&&""!==this.baseUri.authority()&&""===r.authority()&&(r=r.absoluteTo(this.baseUri))}return this.transformRef?this.transformRef(Object.assign(Object.assign({},e),{ref:r,uri:this.baseUri}),this.ctx):r}),this.atMaxUriDepth=(()=>this.uriStack.length>=100),this.lookupUri=(e=>__awaiter(this,void 0,void 0,function*(){const{ref:t}=e;let r=t.scheme();!this.resolvers[r]&&this.isFile(t)&&(r="file");const s=this.resolvers[r];if(!s)throw new Error(`No resolver defined for scheme '${t.scheme()||"file"}' in ref ${t.toString()}`);let i=yield s.resolve(t,this.ctx);if(this.parseResolveResult)try{i=(yield this.parseResolveResult({uriResult:i,result:i,targetAuthority:t,parentAuthority:this.baseUri,parentPath:e.parentPath,fragment:e.fragment})).result}catch(e){throw new Error(`Could not parse remote reference response for '${t.toString()}' - ${String(e)}`)}return new ResolveRunner(i,this.graph,{depth:this.depth+1,baseUri:t.toString(),root:t,uriStack:this.uriStack,uriCache:this.uriCache,resolvers:this.resolvers,transformRef:this.transformRef,parseResolveResult:this.parseResolveResult,transformDereferenceResult:this.transformDereferenceResult,dereferenceRemote:this.dereferenceRemote,dereferenceInline:this.dereferenceInline,ctx:this.ctx})})),this.lookupAndResolveUri=(e=>__awaiter(this,void 0,void 0,function*(){const{val:t,ref:r,resolvingPointer:s,parentPointer:i,pointerStack:o}=e,n=(e.parentPath||[]).slice(),a=this.computeUriCacheKey(r),h={uri:r,pointerStack:o,targetPath:s===i?[]:n};if(this.uriStack.includes(a))return h.resolved={result:t,graph:this.graph,refMap:{},errors:[],runner:this},h;{let e;try{if(this.atMaxUriDepth())throw new Error(`Max uri depth (${this.uriStack.length}) reached. Halting, this is probably a circular loop.`);e=yield this.lookupUri({ref:r.clone().fragment(""),fragment:r.fragment(),cacheKey:a,parentPath:n});const t=this.baseUri.toString();t&&0!==this.depth&&(e.uriStack=e.uriStack.concat([t]))}catch(e){h.error={code:"RESOLVE_URI",message:String(e),uri:r,uriStack:this.uriStack,pointerStack:o,path:n}}if(e&&(h.resolved=yield e.resolve({jsonPointer:uriToJSONPointer(r),parentPath:n}),h.resolved.errors.length))for(const e of h.resolved.errors)if("POINTER_MISSING"===e.code&&e.path.join("/")===r.fragment().slice(1)){const s=r.fragment?json.trimStart(e.path,json.trimStart(r.fragment(),"/").split("/")):e.path;s&&s.length?lodash.set(h.resolved.result,s,t):h.resolved.result&&(h.resolved.result=t)}}return h})),this.id=resolveRunnerCount+=1,this.depth=r.depth||0,this._source=e,this.resolvers=r.resolvers||{};const s=r.baseUri||"";let i=new URI(s||"");this.isFile(i)&&(i=new URI(path.toFSPath(s))),this.baseUri=i,this.uriStack=r.uriStack||[],this.uriCache=r.uriCache||new Cache,this.root=r.root&&r.root.toString()||this.baseUri.toString()||"root",this.graph=t,this.graph.hasNode(this.root)||this.graph.addNode(this.root,{refMap:{},data:this._source}),this.baseUri&&0===this.depth&&this.uriCache.set(this.computeUriCacheKey(this.baseUri),this),this.getRef=r.getRef||defaultGetRef,this.transformRef=r.transformRef,this.depth?this.dereferenceInline=!0:this.dereferenceInline=void 0===r.dereferenceInline||r.dereferenceInline,this.dereferenceRemote=void 0===r.dereferenceRemote||r.dereferenceRemote,this.parseResolveResult=r.parseResolveResult,this.transformDereferenceResult=r.transformDereferenceResult,this.ctx=r.ctx,this.lookupUri=memoize(this.lookupUri,{serializer:this._cacheKeySerializer,cache:{create:()=>this.uriCache}})}get source(){return this._source}resolve(e){return __awaiter(this,void 0,void 0,function*(){const t={result:this.source,graph:this.graph,refMap:{},errors:[],runner:this};let r;const s=e&&e.jsonPointer&&e.jsonPointer.trim();if(s&&"#"!==s&&"#/"!==s&&(r=json.pointerToPath(s),t.result=lodash.get(t.result,r)),void 0===t.result)return t.errors.push({code:"POINTER_MISSING",message:`'${s}' does not exist @ '${this.baseUri.toString()}'`,uri:this.baseUri,uriStack:this.uriStack,pointerStack:[],path:r||[]}),t;const i=new ResolveCrawler(this,s);i.computeGraph(t.result,r,s||"");let o=[];if(i.resolvers.length&&(o=yield Promise.all(i.resolvers)),o.length)for(const e of o){let s=e.targetPath;s.length||(s=r||[]),t.refMap[String(this.baseUri.clone().fragment(json.pathToPointer(s)))]=String(e.uri),this._setGraphNodeEdge(String(this.root),json.pathToPointer(s),String(e.uri)),e.error&&t.errors.push(e.error),e.resolved&&(e.resolved.errors&&(t.errors=t.errors.concat(e.resolved.errors)),void 0!==e.resolved.result&&(this._source=produce__default(this._source,t=>{if(e.resolved){if(!s.length)return e.resolved.result;lodash.set(t,s,e.resolved.result),this._setGraphNodeData(String(e.uri),e.resolved.result)}})))}if("object"==typeof this._source?(this.dereferenceInline&&(this._source=produce__default(this._source,e=>{let r=[];try{r=i.pointerGraph.overallOrder();for(const s of r){const r=i.pointerGraph.dependantsOf(s);if(!r.length)continue;const o=json.pointerToPath(s),n=lodash.get(e,o);for(const a of r){let r;const h=json.pointerToPath(a),c=i.pointerStemGraph.dependenciesOf(s);for(const e of c)if(json.startsWith(h,json.pointerToPath(e))){r=!0;break}r||(t.refMap[json.pathToPointer(h)]=json.pathToPointer(o),this._setGraphNodeEdge(this.root,json.pathToPointer(h),json.pathToPointer(o)),void 0!==n?(lodash.set(e,h,n),this._setGraphNodeData(json.pathToPointer(o),produce.original(n))):t.errors.push({code:"POINTER_MISSING",message:`'${s}' does not exist`,path:h,uri:this.baseUri,uriStack:this.uriStack,pointerStack:[]}))}}}catch(e){}})),t.result=r?lodash.get(this._source,r):this._source):t.result=this._source,this.transformDereferenceResult){const i=new URI(s||"");try{const{result:s,error:o}=yield this.transformDereferenceResult({source:this.source,result:t.result,targetAuthority:i,parentAuthority:this.baseUri,parentPath:e&&e.parentPath||[],fragment:i.fragment()});if(t.result=s,o)throw new Error(`Could not transform dereferenced result for '${i.toString()}' - ${String(o)}`)}catch(e){t.errors.push({code:"TRANSFORM_DEREFERENCED",message:`Error: Could not transform dereferenced result for '${this.baseUri.toString()}${""!==i.fragment()?`#${i.fragment()}`:""}' - ${String(e)}`,uri:i,uriStack:this.uriStack,pointerStack:[],path:r})}}return this._setGraphNodeData(this.root,this._source),t})}_cacheKeySerializer(e){return e&&"object"==typeof e&&e.cacheKey?e.cacheKey:JSON.stringify(arguments)}computeUriCacheKey(e){return e.clone().fragment("").toString()}isFile(e){const t=e.scheme();if("file"===t)return!0;if(t){if(!this.resolvers[t])return!0}else{if("/"===e.toString().charAt(0))return!0;if(this.baseUri){const e=this.baseUri.scheme();return Boolean(!e||"file"===e||!this.resolvers[e])}}return!1}_setGraphNodeData(e,t){if(!this.graph.hasNode(e))return;const r=this.graph.getNodeData(e)||{};r.data=t,this.graph.setNodeData(e,r)}_setGraphNodeEdge(e,t,r){if(!this.graph.hasNode(e))return;const s=this.graph.getNodeData(e)||{};s.refMap=s.refMap||{},s.refMap[t]=r,this.graph.setNodeData(e,s)}}class Resolver{constructor(e={}){this.ctx={},this.uriCache=e.uriCache||new Cache,this.resolvers=e.resolvers||{},this.getRef=e.getRef,this.transformRef=e.transformRef,this.dereferenceInline=void 0===e.dereferenceInline||e.dereferenceInline,this.dereferenceRemote=void 0===e.dereferenceRemote||e.dereferenceRemote,this.parseResolveResult=e.parseResolveResult,this.transformDereferenceResult=e.transformDereferenceResult,this.ctx=e.ctx}resolve(e,t={}){const r=new dependencyGraph.DepGraph({circular:!0});return new ResolveRunner(e,r,Object.assign(Object.assign({uriCache:this.uriCache,resolvers:this.resolvers,getRef:this.getRef,transformRef:this.transformRef,dereferenceInline:this.dereferenceInline,dereferenceRemote:this.dereferenceRemote,parseResolveResult:this.parseResolveResult,transformDereferenceResult:this.transformDereferenceResult},t),{ctx:Object.assign({},this.ctx||{},t.ctx||{})})).resolve(t)}}exports.Cache=Cache,exports.Resolver=Resolver,exports.defaultGetRef=defaultGetRef;
